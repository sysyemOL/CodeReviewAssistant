# 对话框优化 - 调整大小功能

## 问题描述

### 1. MonacoDiffEditor 中残留的关闭按钮逻辑
虽然已将关闭按钮移到父组件，但 `MonacoDiffEditor` 内部仍保留了 ESC 键监听和 `handleClose` 函数，造成代码冗余。

### 2. "拖拽移动·双击重置" 文字超出右边框
对话框标题栏的提示文字在某些情况下会超出对话框右边框，影响美观。

### 3. 缺少调节大小功能
用户希望能够通过拖拽对话框四角来调整对话框大小，以便更灵活地查看代码差异。

## 解决方案

### 1. 清理 MonacoDiffEditor 多余代码

#### 删除的代码

**ESC键监听**：
```javascript
// 删除
const handleKeyDown = (e) => {
  if (e.key === 'Escape') {
    handleClose()
  }
}

onMounted(() => {
  // 删除
  document.addEventListener('keydown', handleKeyDown)
  // ...
})

onUnmounted(() => {
  // 删除
  document.removeEventListener('keydown', handleKeyDown)
  // ...
})
```

**handleClose 函数**：
```javascript
// 删除
const handleClose = () => {
  emit('close')
}
```

### 2. 修复标题文字超出问题

#### 优化标题文字
```vue
<!-- 缩短文字 -->
<span v-if="fileStore.currentFile" class="drag-hint">可拖拽 · 双击重置</span>
```
从"拖拽移动·双击重置"改为"可拖拽·双击重置"，更简洁。

#### 优化CSS布局
```css
/* 标题内容布局 */
.dialog-header-content {
  display: flex;
  align-items: center;
  justify-content: space-between;
  width: calc(100% - 40px);  /* 留出左右边距 */
  margin-left: 20px;
  margin-right: 20px;
  gap: 16px;  /* 标题和提示文字之间的间隔 */
}

.drag-hint {
  color: var(--el-text-color-secondary);
  font-size: 12px;
  font-weight: 400;
  display: flex;
  align-items: center;
  gap: 8px;
  white-space: nowrap;  /* 防止换行 */
  flex-shrink: 0;  /* 不允许收缩 */
  animation: fadeIn 0.5s ease;
}
```

### 3. 添加四角拖拽调节大小功能

#### 3.1 添加Resize手柄

```vue
<!-- 四角拖拽手柄（仅在有编辑器时显示） -->
<template v-if="fileStore.currentFile">
  <div class="resize-handle resize-handle-tl" @mousedown="startResize($event, 'tl')"></div>
  <div class="resize-handle resize-handle-tr" @mousedown="startResize($event, 'tr')"></div>
  <div class="resize-handle resize-handle-bl" @mousedown="startResize($event, 'bl')"></div>
  <div class="resize-handle resize-handle-br" @mousedown="startResize($event, 'br')"></div>
</template>
```

**说明**：
- `tl`: top-left (左上角)
- `tr`: top-right (右上角)
- `bl`: bottom-left (左下角)
- `br`: bottom-right (右下角)

#### 3.2 添加Resize状态

```javascript
// Resize相关状态
const isResizing = ref(false)
const resizeDirection = ref('')
const resizeStartPos = ref({ x: 0, y: 0 })
const dialogSize = ref({ width: 0, height: 0 })
const initialDialogSize = ref({ width: 0, height: 0 })

// 初始化对话框大小
const initDialogSize = () => {
  const codePanelWidth = parseFloat(
    getComputedStyle(document.documentElement)
      .getPropertyValue('--code-panel-width') || '600'
  )
  const width = window.innerWidth - codePanelWidth
  const height = window.innerHeight - 100
  
  dialogSize.value = { width, height }
  initialDialogSize.value = { width, height }
}
```

#### 3.3 实现Resize逻辑

**开始调整大小**：
```javascript
const startResize = (e, direction) => {
  e.preventDefault()
  e.stopPropagation()
  
  isResizing.value = true
  resizeDirection.value = direction
  resizeStartPos.value = { x: e.clientX, y: e.clientY }
  
  // 记录初始大小
  let dialogEl = document.querySelector('.diff-dialog-wrapper.with-editor .el-dialog')
  if (!dialogEl) {
    const dialogs = document.querySelectorAll('.el-dialog')
    dialogEl = dialogs[dialogs.length - 1]
  }
  
  if (dialogEl) {
    const rect = dialogEl.getBoundingClientRect()
    initialDialogSize.value = {
      width: rect.width,
      height: rect.height
    }
  }
  
  // 添加全局事件监听
  document.addEventListener('mousemove', handleResizeMove)
  document.addEventListener('mouseup', handleResizeEnd)
}
```

**调整大小中**：
```javascript
const handleResizeMove = (e) => {
  if (!isResizing.value) return
  
  const deltaX = e.clientX - resizeStartPos.value.x
  const deltaY = e.clientY - resizeStartPos.value.y
  
  const direction = resizeDirection.value
  let newWidth = initialDialogSize.value.width
  let newHeight = initialDialogSize.value.height
  
  // 最小尺寸限制
  const minWidth = 600
  const minHeight = 400
  
  // 根据方向计算新尺寸
  if (direction.includes('r')) { // right
    newWidth = Math.max(minWidth, initialDialogSize.value.width + deltaX)
  }
  if (direction.includes('l')) { // left
    newWidth = Math.max(minWidth, initialDialogSize.value.width - deltaX)
  }
  if (direction.includes('b')) { // bottom
    newHeight = Math.max(minHeight, initialDialogSize.value.height + deltaY)
  }
  if (direction.includes('t')) { // top
    newHeight = Math.max(minHeight, initialDialogSize.value.height - deltaY)
  }
  
  // 最大尺寸限制
  const codePanelWidth = parseFloat(
    getComputedStyle(document.documentElement)
      .getPropertyValue('--code-panel-width') || '600'
  )
  const maxWidth = window.innerWidth - codePanelWidth - 40
  const maxHeight = window.innerHeight - 100
  
  dialogSize.value = {
    width: Math.min(maxWidth, newWidth),
    height: Math.min(maxHeight, newHeight)
  }
  
  // 如果是从左边调整，需要同时调整位置
  let dialogEl = document.querySelector('.diff-dialog-wrapper.with-editor .el-dialog')
  if (dialogEl && direction.includes('l')) {
    const actualDelta = newWidth - initialDialogSize.value.width
    dialogPosition.value.x -= actualDelta
    dialogEl.style.transform = `translate(${dialogPosition.value.x}px, ${dialogPosition.value.y}px)`
  }
}
```

**结束调整**：
```javascript
const handleResizeEnd = () => {
  isResizing.value = false
  resizeDirection.value = ''
  
  // 移除全局事件监听
  document.removeEventListener('mousemove', handleResizeMove)
  document.removeEventListener('mouseup', handleResizeEnd)
}
```

#### 3.4 更新双击重置功能

```javascript
const handleDoubleClick = () => {
  dialogPosition.value = { x: 0, y: 0 }
  
  let dialogEl = document.querySelector('.diff-dialog-wrapper.with-editor .el-dialog')
  if (!dialogEl) {
    const dialogs = document.querySelectorAll('.el-dialog')
    dialogEl = dialogs[dialogs.length - 1]
  }
  
  if (dialogEl) {
    dialogEl.style.transform = 'translate(0px, 0px)'
  }
  
  // 重置大小
  initDialogSize()
  
  ElMessage.success('位置和大小已重置')
}
```

#### 3.5 添加Resize手柄样式

```css
/* Resize手柄样式 */
.resize-handle {
  position: absolute;
  z-index: 10;
  background: transparent;
  transition: background-color 0.2s ease;
}

.resize-handle:hover {
  background-color: rgba(64, 158, 255, 0.3);
}

/* 四角手柄 */
.resize-handle-tl {
  top: 0;
  left: 0;
  width: 12px;
  height: 12px;
  cursor: nwse-resize;  /* 西北-东南方向 */
}

.resize-handle-tr {
  top: 0;
  right: 0;
  width: 12px;
  height: 12px;
  cursor: nesw-resize;  /* 东北-西南方向 */
}

.resize-handle-bl {
  bottom: 0;
  left: 0;
  width: 12px;
  height: 12px;
  cursor: nesw-resize;  /* 东北-西南方向 */
}

.resize-handle-br {
  bottom: 0;
  right: 0;
  width: 12px;
  height: 12px;
  cursor: nwse-resize;  /* 西北-东南方向 */
}

/* 调整大小时的样式 */
.diff-dialog-wrapper.resizing :deep(.el-dialog) {
  transition: none !important;
  user-select: none;
}

.diff-dialog-wrapper.resizing :deep(.el-dialog__body) {
  pointer-events: none;  /* 调整时禁用内容区域的鼠标事件 */
}
```

## 技术要点

### 1. Resize手柄定位

手柄使用 `position: absolute` 定位在对话框的四个角落，每个手柄12x12px，足够大以便操作。

### 2. 尺寸限制

- **最小尺寸**：宽度600px，高度400px
- **最大尺寸**：
  - 宽度：`window.innerWidth - codePanelWidth - 40`
  - 高度：`window.innerHeight - 100`

### 3. 左侧调整位置同步

当从左上角或左下角调整大小时，需要同时调整对话框的位置，以保持视觉上的稳定性。

```javascript
if (dialogEl && direction.includes('l')) {
  const actualDelta = newWidth - initialDialogSize.value.width
  dialogPosition.value.x -= actualDelta
  dialogEl.style.transform = `translate(${dialogPosition.value.x}px, ${dialogPosition.value.y}px)`
}
```

### 4. 调整时禁用过渡和交互

```css
.diff-dialog-wrapper.resizing :deep(.el-dialog) {
  transition: none !important;  /* 禁用过渡动画，实现实时调整 */
  user-select: none;  /* 禁用文本选择 */
}

.diff-dialog-wrapper.resizing :deep(.el-dialog__body) {
  pointer-events: none;  /* 禁用内容区域的鼠标事件，避免干扰 */
}
```

### 5. 鼠标光标指示

不同方向的resize手柄使用不同的光标：
- 左上/右下角：`nwse-resize`（西北-东南）
- 右上/左下角：`nesw-resize`（东北-西南）

### 6. 视觉反馈

鼠标悬停时，手柄显示半透明蓝色背景：
```css
.resize-handle:hover {
  background-color: rgba(64, 158, 255, 0.3);
}
```

## 效果验证

### 测试步骤
1. ✅ 打开代码编辑器，上传文件
2. ✅ 点击"查看代码差异"，对话框显示
3. ✅ 鼠标移到对话框四个角落，应显示对应的resize光标
4. ✅ 拖拽右下角，对话框应向右下扩大
5. ✅ 拖拽左上角，对话框应向左上扩大（位置同步移动）
6. ✅ 尝试缩小对话框，应受最小尺寸限制（600x400）
7. ✅ 尝试扩大超过屏幕，应受最大尺寸限制
8. ✅ 双击标题栏，对话框位置和大小应重置

### 预期效果
- ✅ 四个角都可以拖拽调整大小
- ✅ 调整时鼠标光标正确显示
- ✅ 调整时对话框实时响应，无卡顿
- ✅ 受最小/最大尺寸限制，不会过小或超出屏幕
- ✅ 双击标题栏可重置位置和大小
- ✅ 标题文字不再超出右边框
- ✅ 代码清洁，无冗余逻辑

## 相关文件

- `vue3-front/vue-project/src/components/chat/MessageItem.vue` - 添加resize功能，优化标题布局
- `vue3-front/vue-project/src/components/common/MonacoDiffEditor.vue` - 清理冗余关闭逻辑

## 用户体验优化

1. **灵活性**：用户可自由调整对话框大小，适应不同的代码查看需求
2. **视觉反馈**：手柄悬停高亮，光标变化，让操作更直观
3. **智能限制**：最小/最大尺寸限制，避免对话框过小或过大
4. **便捷重置**：双击标题栏即可恢复默认大小和位置
5. **简洁文字**："可拖拽·双击重置"更简短清晰
6. **代码整洁**：移除冗余代码，提高可维护性

